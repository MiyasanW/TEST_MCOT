{% extends "admin/base_site.html" %}
{% load static %}
{% load i18n %}

{% block extrahead %}
{{ block.super }}
<style>
    .card-counter {
        box-shadow: 2px 2px 10px #DADADA;
        margin: 5px;
        padding: 20px 10px;
        background-color: #fff;
        height: 100px;
        border-radius: 5px;
        transition: .3s linear all;
    }

    .card-counter:hover {
        box-shadow: 4px 4px 20px #DADADA;
        transition: .3s linear all;
    }

    .card-counter.primary {
        background-color: #007bff;
        color: #FFF;
    }

    .card-counter.danger {
        background-color: #ef5350;
        color: #FFF;
    }

    .card-counter.success {
        background-color: #66bb6a;
        color: #FFF;
    }

    .card-counter.info {
        background-color: #26c6da;
        color: #FFF;
    }

    .card-counter i {
        font-size: 5em;
        opacity: 0.2;
        position: absolute;
        right: 15px;
        top: 15px;
    }

    .card-counter .count-numbers {
        position: absolute;
        right: 35px;
        top: 20px;
        font-size: 32px;
        display: block;
    }

    .card-counter .count-name {
        position: absolute;
        right: 35px;
        top: 65px;
        font-style: italic;
        text-transform: capitalize;
        opacity: 0.8;
        display: block;
        font-size: 18px;
    }

    .badge-priority-low {
        background-color: #28a745;
        color: white;
    }

    .badge-priority-medium {
        background-color: #ffc107;
        color: black;
    }

    .badge-priority-high {
        background-color: #fd7e14;
        color: white;
    }

    .badge-priority-critical {
        background-color: #dc3545;
        color: white;
    }

    .table td {
        vertical-align: middle;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h3 mb-0 text-gray-800"><i class="fas fa-tools mr-2"></i> รายงานการแจ้งปัญหา (Maintenance & Issues)
        </h2>
        <div>
            <a href="{% url 'reports_dashboard' %}" class="btn btn-secondary btn-sm"><i class="fas fa-arrow-left"></i>
                กลับไปหน้ารายงานรวม</a>
            <a href="?export=csv" class="btn btn-success btn-sm"><i class="fas fa-file-csv"></i> Export CSV</a>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card-counter danger">
                <i class="fas fa-exclamation-circle"></i>
                <span class="count-numbers">{{ critical_issues }}</span>
                <span class="count-name">ด่วนที่สุด (Critical)</span>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card-counter info">
                <i class="fas fa-tools"></i>
                <span class="count-numbers">{{ open_issues }}</span>
                <span class="count-name">รอการแก้ไข (Active)</span>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card-counter primary">
                <i class="fas fa-list"></i>
                <span class="count-numbers">{{ total_issues }}</span>
                <span class="count-name">ทั้งหมด (Total)</span>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">ตัวกรองข้อมูล</h6>
        </div>
        <div class="card-body">
            <form method="get" class="form-inline">
                <label class="mr-2">สถานะ:</label>
                <select name="status" class="form-control mr-3">
                    <option value="">ทั้งหมด</option>
                    <option value="new" {% if current_status == 'new' %}selected{% endif %}>New</option>
                    <option value="investigating" {% if current_status == 'investigating' %}selected{% endif %}>
                        Investigating</option>
                    <option value="fixed" {% if current_status == 'fixed' %}selected{% endif %}>Fixed</option>
                    <option value="closed" {% if current_status == 'closed' %}selected{% endif %}>Closed</option>
                </select>

                <label class="mr-2">ความสำคัญ:</label>
                <select name="priority" class="form-control mr-3">
                    <option value="">ทั้งหมด</option>
                    <option value="low" {% if current_priority == 'low' %}selected{% endif %}>Low</option>
                    <option value="medium" {% if current_priority == 'medium' %}selected{% endif %}>Medium</option>
                    <option value="high" {% if current_priority == 'high' %}selected{% endif %}>High</option>
                    <option value="critical" {% if current_priority == 'critical' %}selected{% endif %}>Critical</option>
                </select>

                <button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-filter"></i> กรองข้อมูล</button>
                <a href="{% url 'reports_maintenance' %}" class="btn btn-light btn-sm ml-2">ล้างค่า</a>
            </form>
        </div>
    </div>

    <!-- Table -->
    <div class="card shadow mb-4">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover" width="100%" cellspacing="0">
                    <thead class="thead-light">
                        <tr>
                            <th>ID</th>
                            <th>หัวข้อปัญหา</th>
                            <th>ความสำคัญ</th>
                            <th>สถานะ</th>
                            <th>เกี่ยวข้องกับ</th>
                            <th>ผู้แจ้ง</th>
                            <th>วันที่แจ้ง</th>
                            <th>จัดการ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for issue in issues %}
                        <tr>
                            <td>#{{ issue.id }}</td>
                            <td>
                                <strong>{{ issue.title }}</strong><br>
                                <small class="text-muted">{{ issue.description|truncatechars:50 }}</small>
                            </td>
                            <td>
                                <span class="badge badge-priority-{{ issue.priority }} px-2 py-1">
                                    {{ issue.get_priority_display }}
                                </span>
                            </td>
                            <td>
                                <span class="badge badge-secondary">{{ issue.get_status_display }}</span>
                            </td>
                            <td>
                                {% if issue.booking %}
                                <div><i class="fas fa-calendar-alt text-primary"></i> <a
                                        href="{% url 'admin:rentals_booking_change' issue.booking.id %}">Booking #{{
                                        issue.booking.id }}</a></div>
                                <small>{{ issue.booking.customer_name }}</small>
                                {% endif %}
                                {% if issue.equipment %}
                                <div><i class="fas fa-camera text-info"></i> {{ issue.equipment.name }}</div>
                                {% endif %}
                                {% if issue.studio %}
                                <div><i class="fas fa-door-open text-warning"></i> {{ issue.studio.name }}</div>
                                {% endif %}
                                {% if not issue.booking and not issue.equipment and not issue.studio %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>{{ issue.reporter.username }}</td>
                            <td>{{ issue.created_at|date:"d/m/Y H:i" }}</td>
                            <td>
                                <a href="{% url 'admin:rentals_issuereport_change' issue.id %}"
                                    class="btn btn-info btn-sm btn-circle" title="แก้ไข/จัดการ">
                                    <i class="fas fa-edit"></i>
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" class="text-center py-5 text-muted">
                                <i class="fas fa-check-circle fa-3x mb-3 text-success"></i><br>
                                ไม่พบรายการแจ้งปัญหาตามเงื่อนไขที่เลือก
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>
{% endblock %}